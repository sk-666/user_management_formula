{% set users = {} %}
{% set default_user_data = {
    'uid': '',
    'gid': '',
    'usergroup': True,
    'groups': [],
    'home': '',
    'shell': '/bin/sh',
    'system': False,
    'fullname': '',
    'expire': -1,
  }
%}
{% set pillar_users = pillar.get('users')%}
{% for user_name, data in pillar_users.items() %}
  {% do users.update({user_name:{} }) %}
  {% do users[user_name].update(salt["defaults.merge"](data, default_user_data, in_place=False)) %}
{% endfor %}

{% set users_ssh_generate = {} %}
{% for user_name, data in users.items() %}
  {% if data.ssh_auth is defined and not data.ssh_auth.ssh_keys is defined %}
    {% do users_ssh_generate.update({user_name:data})%}
  {% endif %}
{% endfor %}
